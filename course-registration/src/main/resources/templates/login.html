<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¡œê·¸ì¸</title>
  <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: flex; justify-content: center; align-items: center; height: 100vh;
        background-color: #f0f2f5; margin: 0;
    }
    .login-box {
        background: white; padding: 40px; border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 320px; text-align: center;
    }
    h2 { color: #333; margin-bottom: 30px; }
    input {
        width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd;
        border-radius: 8px; box-sizing: border-box; font-size: 14px;
    }
    input:focus { outline: none; border-color: #007bff; }
    button {
        width: 100%; padding: 12px; background-color: #007bff; color: white;
        border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;
        transition: background 0.3s;
    }
    button:hover { background-color: #0056b3; }
    .join-link { margin-top: 20px; font-size: 14px; color: #666; }
    .join-link a { color: #007bff; text-decoration: none; font-weight: bold; margin-left: 5px; }
    .join-link a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<div class="login-box">
  <h2>ğŸ” ë¡œê·¸ì¸</h2>
  <form id="loginForm">
    <input type="text" id="username" placeholder="ì•„ì´ë”” (í•™ë²ˆ)" required>
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
    <button type="submit">ë¡œê·¸ì¸</button>
  </form>

  <div class="join-link">
    ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
    <a href="/join">íšŒì›ê°€ì… í•˜ê¸°</a>
  </div>
</div>

<script>
  const loginForm = document.getElementById('loginForm');

  loginForm.addEventListener('submit', function(e) {
      e.preventDefault(); // í¼ì´ ë©‹ëŒ€ë¡œ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” ê²ƒ ë°©ì§€

      const usernameVal = document.getElementById('username').value;
      const passwordVal = document.getElementById('password').value;

      // 1. ì„œë²„ë¡œ JSON ë°ì´í„° ì „ì†¡
      // SecurityConfigì—ì„œ .loginProcessingUrl("/login")ìœ¼ë¡œ ì„¤ì •ëœ ì£¼ì†Œ
      fetch('/login', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json' // "ë‚˜ JSON ë³´ë‚¸ë‹¤!"ë¼ê³  ì•Œë¦¼
          },
          body: JSON.stringify({
              username: usernameVal, // LoginFilterê°€ map.get("username")ìœ¼ë¡œ ì°¾ìŒ
              password: passwordVal
          })
      })
      .then(response => {
          if (response.ok) {
              // 2. í—¤ë”ì—ì„œ í† í°ê³¼ ì—­í•  êº¼ë‚´ê¸°
              const token = response.headers.get("Authorization");
              const role = response.headers.get("Role");

              if (!token) {
                  alert("ì„œë²„ ì˜¤ë¥˜: í† í°ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                  return;
              }

              // 3. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ (API í˜¸ì¶œìš©)
              localStorage.setItem('Authorization', token);

              // 4. â˜… [í•µì‹¬] ì¿ í‚¤ ì €ì¥ (í˜ì´ì§€ ì´ë™ ì‹œ Thymeleaf ì—ëŸ¬ ë°©ì§€ìš©)
              // "Bearer " ê¸€ìë¥¼ ë¹¼ê³  ìˆœìˆ˜ í† í°ë§Œ ì €ì¥í•´ì•¼ í•„í„°ê°€ ì˜ ì¸ì‹í•¨
              const cleanToken = token.replace("Bearer ", "");

              // ì¿ í‚¤ êµ½ê¸° (ë§Œë£Œì‹œê°„ 1ì‹œê°„)
              document.cookie = `Authorization=${cleanToken}; path=/; max-age=3600`;

              // 5. ì—­í• ì— ë”°ë¼ í˜ì´ì§€ ì´ë™
              alert("ë¡œê·¸ì¸ ì„±ê³µ!");

              if(role === "ROLE_ADMIN") {
                  location.href = '/admin/lectures'; // ê´€ë¦¬ì í˜ì´ì§€ 
              } else {
                  location.href = '/main'; // í•™ìƒ ë©”ì¸ í˜ì´ì§€
              }

          } else {
              // 401 Unauthorized ì—ëŸ¬ ì‹œ
              alert("ë¡œê·¸ì¸ ì‹¤íŒ¨! ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
          }
      })
      .catch(error => {
          console.error("ì—ëŸ¬ ë°œìƒ:", error);
          alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      });
  });
</script>
</body>
</html>