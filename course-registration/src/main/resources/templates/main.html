<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìˆ˜ê°•ì‹ ì²­ ì‹œìŠ¤í…œ</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* í—¤ë” ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (ì œëª© + ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼) */
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .header-box h2 { border-left: 5px solid #0056b3; padding-left: 10px; color: #333; margin: 0; }

        table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th { background-color: #f0f2f5; color: #333; padding: 10px; border: 1px solid #ddd; font-size: 14px; }
        td { padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 14px; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-apply { background-color: #0056b3; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
        .btn-apply:hover { background-color: #004494; }

        /* ë§ˆê°ëœ ê°•ì˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-disabled:hover { background-color: #ccc; }

        .btn-delete { background-color: #ff6b6b; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
        .btn-delete:hover { background-color: #fa5252; }

        /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-logout { background-color: #6c757d; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; margin-left: 10px;}
        .btn-logout:hover { background-color: #5a6268; }

        .summary { background-color: #fff; padding: 15px; border-radius: 5px; margin-bottom: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .total-credit { color: #d6336c; }
    </style>
</head>
<body>

<div class="container">

    <div class="header-box">
        <h2>ğŸ“– ê°œì„¤ ê³¼ëª© ì¡°íšŒ</h2>
        <div>
            <span style="color: #555; font-weight: bold;">
                <span th:text="${#authentication?.name}">ì‚¬ìš©ì</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!
            </span>
            <button onclick="logout()" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <table>
        <thead>
        <tr>
            <th style="width:60px">ì‹ ì²­</th>
            <th>í•™ê³¼</th>
            <th>êµê³¼ëª©ëª…</th>
            <th>ë‹´ë‹¹êµìˆ˜</th>
            <th>í•™ì </th>
            <th>ê°•ì˜ì‹œê°„</th>
            <th>ì‹ ì²­/ì •ì›</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="lecture : ${lectures}">
            <td>
                <button class="btn-apply"
                        th:if="${lecture.currentCount < lecture.maxStudent}"
                        th:onclick="'applyCourse(' + ${lecture.id} + ')'">ì‹ ì²­</button>

                <button class="btn-apply btn-disabled"
                        th:unless="${lecture.currentCount < lecture.maxStudent}"
                        disabled>ë§ˆê°</button>
            </td>
            <td>ì»´í“¨í„°ê³µí•™</td>
            <td th:text="${lecture.lectureName}" style="font-weight:bold; text-align:left; padding-left:20px;"></td>
            <td th:text="${lecture.professor}"></td>
            <td th:text="${lecture.credit} + 'í•™ì '"></td>
            <td th:text="${lecture.time != null ? lecture.time : 'ì›” 1,2'}"></td>
            <td>
                <span th:text="${lecture.currentCount}"></span> / <span th:text="${lecture.maxStudent}"></span>
            </td>
        </tr>

        <tr th:if="${#lists.isEmpty(lectures)}">
            <td colspan="7" style="padding: 30px; color: #999;">í˜„ì¬ ê°œì„¤ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
        </tbody>
    </table>

    <h2>ğŸ’ ìˆ˜ê°• ì‹ ì²­ ë‚´ì—­ (í¬ë§êµê³¼ëª©)</h2>

    <div class="summary">
        <span>í˜„ì¬ ì‹ ì²­ ê³¼ëª© ìˆ˜: <span th:text="${myLectures != null ? #lists.size(myLectures) : 0}">0</span>ê³¼ëª©</span>
        <span class="total-credit">ì´ ì‹ ì²­ í•™ì : <span id="totalCredit">0</span>í•™ì  / 21í•™ì </span>
    </div>

    <table>
        <thead>
        <tr>
            <th style="width: 60px">ì‚­ì œ</th>
            <th>í•™ê³¼</th>
            <th>êµê³¼ëª©ëª…</th>
            <th>ë‹´ë‹¹êµìˆ˜</th>
            <th>í•™ì </th>
            <th>ê°•ì˜ì‹œê°„</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="myLecture : ${myLectures}">
            <td>
                <button class="btn-delete"
                        th:onclick="'cancelCourse(' + ${myLecture.id} + ')'">ì‚­ì œ</button>
            </td>
            <td>ì»´í“¨í„°ê³µí•™</td>
            <td th:text="${myLecture.lectureName}" style="font-weight:bold; text-align:left; padding-left:20px;"></td>
            <td th:text="${myLecture.professor}"></td>
            <td class="credit-val" th:text="${myLecture.credit}">3</td>
            <td th:text="${myLecture.time != null ? myLecture.time : 'ì›” 1,2'}"></td>
        </tr>

        <tr th:if="${myLectures == null or #lists.isEmpty(myLectures)}">
            <td colspan="6" style="padding: 30px; color: #999;">ì‹ ì²­í•œ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
        </tbody>
    </table>
</div>

<script>
    // 1. í˜ì´ì§€ ì—´ë¦¬ìë§ˆì ì´ í•™ì  ê³„ì‚°í•˜ê¸°
    document.addEventListener("DOMContentLoaded", function() {
        let total = 0;
        document.querySelectorAll('.credit-val').forEach(td => {
            total += parseInt(td.innerText);
        });
        document.getElementById('totalCredit').innerText = total;
    });

    // 2. ìˆ˜ê°• ì‹ ì²­ í•¨ìˆ˜
    function applyCourse(id) {
        if(!confirm("ì´ ê°•ì˜ë¥¼ ìˆ˜ê°• ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const token = localStorage.getItem("Authorization");

        fetch('/enrollment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify({ lectureId: id.toString() })
        })
        .then(async response => {
            if (response.ok) {
                return response.text();
            } else {
                const errorMessage = await response.text();
                throw new Error(errorMessage);
            }
        })
        .then(message => {
            alert(message);
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message);
        });
    }

    // 3. ìˆ˜ê°• ì·¨ì†Œ í•¨ìˆ˜
    function cancelCourse(id) {
        if(!confirm("ì •ë§ ìˆ˜ê°•ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const token = localStorage.getItem("Authorization");

        fetch('/enrollment', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify({ lectureId: id.toString() })
        })
        .then(async response => {
            if (response.ok) {
                return response.text();
            } else {
                const errorMessage = await response.text();
                throw new Error(errorMessage);
            }
        })
        .then(message => {
            alert(message);
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message);
        });
    }

    // 4. ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ (ì¿ í‚¤ ì‚­ì œ ì¶”ê°€ë¨!)
    function logout() {
        if(!confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚­ì œ
        localStorage.removeItem("Authorization");
        localStorage.removeItem("access_token");

        // â˜… [í•µì‹¬] ì¿ í‚¤ ì‚­ì œ (ë§Œë£Œì‹œê°„ 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì¦‰ì‹œ ì‚­ì œ)
        document.cookie = "Authorization=; path=/; max-age=0";

        // ì„œë²„ ë¡œê·¸ì•„ì›ƒ í˜¸ì¶œ ë° ì´ë™
        fetch('/logout', { method: 'POST' })
            .then(() => {
                location.href = "/login.html";
            })
            .catch(() => {
                location.href = "/login.html";
            });
    }
</script>
</body>
</html>